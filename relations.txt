User
 â”œâ”€â”€ hasOne Cart
 â”œâ”€â”€ hasMany Orders

Cart
 â”œâ”€â”€ hasMany CartItems

CartItem
 â”œâ”€â”€ belongsTo Product

Category
 â”œâ”€â”€ hasMany Products

Order
 â”œâ”€â”€ hasMany OrderItems
 â”œâ”€â”€ belongsTo User


 relations work:
 ğŸ§  Big Picture (Mental Model)

This system has 4 main phases:

1ï¸âƒ£ Browsing (no auth)
2ï¸âƒ£ Authentication
3ï¸âƒ£ Cart lifecycle
4ï¸âƒ£ Order & checkout lifecycle

Everything revolves around User â†’ Cart â†’ Order

1ï¸âƒ£ Browsing Products (No Auth)
What happens

User opens app / website

No login required

Models involved

Category

Product

Flow
Category â†’ Products


Example:

Category::with('products')->get();
Product::with('category')->get();


ğŸ“Œ Nothing touches User, Cart, or Order here.

2ï¸âƒ£ Authentication Flow
User registers / logs in

User record is created

Token is issued (Sanctum)

Important design decision

ğŸ‘‰ Cart is NOT created yet

Why?

Not all users shop

Saves DB clutter

3ï¸âƒ£ Cart Lifecycle (Core Logic)

This is the heart of the system.

ğŸ›’ First Add to Cart
Trigger

User clicks â€œAdd to Cartâ€

Flow (very important)

1ï¸âƒ£ Check authentication
2ï¸âƒ£ Check if user already has a cart
3ï¸âƒ£ If not â†’ create one

Models involved
User â†’ Cart â†’ CartItem â†’ Product

Conceptual flow
$user = auth()->user();

$cart = $user->cart ?? Cart::create(['user_id' => $user->id]);


Then:

CartItem::updateOrCreate(
    ['cart_id' => $cart->id, 'product_id' => $productId],
    ['quantity' => DB::raw('quantity + 1')]
);


ğŸ“Œ Stock is not reduced yet

â•â– Update Quantity
Flow

User increases/decreases quantity

Only cart_items.quantity changes

ğŸ“Œ Product stock still untouched

âŒ Remove Item

Delete row from cart_items

Cart still exists

ğŸ§¹ Empty Cart

Delete all cart_items

Keep cart

4ï¸âƒ£ Checkout Flow (CRITICAL)

This is where cart â†’ order conversion happens.

ğŸ§¾ User clicks Checkout
Step 1 â€” Validate input

Depending on payment_method:

Method	Required
cod	address
wish	phone_number
Step 2 â€” Read cart
$cart = $user->cart->load('items.product');


ğŸ“Œ If cart is empty â†’ block checkout

Step 3 â€” Calculate total
$total = 0;

foreach ($cart->items as $item) {
    $total += $item->quantity * $item->product->price;
}

Step 4 â€” Create Order
Models involved
User â†’ Order â†’ OrderItem â†’ Product

$order = Order::create([
    'user_id' => $user->id,
    'payment_method' => 'cod',
    'address' => $address,
    'total_price' => $total,
]);

Step 5 â€” Move Cart Items â†’ Order Items
foreach ($cart->items as $item) {
    OrderItem::create([
        'order_id' => $order->id,
        'product_id' => $item->product_id,
        'quantity' => $item->quantity,
        'price' => $item->product->price,
    ]);

    // reduce stock
    $item->product->decrement('stock', $item->quantity);
}


ğŸ“Œ Price is SNAPSHOTED
ğŸ“Œ Stock reduced ONLY NOW

Step 6 â€” Clear Cart
$cart->items()->delete();

5ï¸âƒ£ Order Status Lifecycle
Default
pending

Admin updates:
pending â†’ shipped â†’ delivered


or:

pending â†’ cancelled


ğŸ“Œ User can ONLY view status
ğŸ“Œ Admin controls status

6ï¸âƒ£ User Profile Flow
Models involved
User â†’ Orders â†’ OrderItems


User views:

$user->orders()->with('items.product')->get();


User updates:

name

email

profile_image

âŒ Cannot edit role or orders

7ï¸âƒ£ Admin Flow

Admin is just a User with role = admin

Admin abilities
Action	Models
Manage users	User
Manage products	Product, Category
Manage orders	Order, OrderItem

Admin routes are protected by:

isAdmin()